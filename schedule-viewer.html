<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart School Schedule - Easy Schedule Reading</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="favicon-16.svg">
    <link rel="shortcut icon" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 400;
        }

        .header p {
            font-size: 0.95em;
            opacity: 0.9;
            margin: 0;
        }

        .content {
            padding: 20px;
        }

        .control-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .control-section h2 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.2em;
        }

        .control-section p {
            color: #666;
            margin-bottom: 12px;
            line-height: 1.4;
            font-size: 0.9em;
        }

        .schedule-loaded-section {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }

        .schedule-loaded-section h2 {
            color: #155724;
            margin-bottom: 8px;
            font-size: 1.2em;
        }

        .schedule-loaded-section p {
            color: #155724;
            margin-bottom: 12px;
            line-height: 1.4;
            font-size: 0.9em;
        }

        .schedule-info {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #c3e6cb;
        }

        .schedule-info h3 {
            color: #155724;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .schedule-info p {
            color: #155724;
            margin: 3px 0;
            font-size: 0.85em;
        }

        .schedule-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #e9ecef;
            flex: 1;
            min-width: 80px;
        }

        .stat-number {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
            display: block;
        }

        .stat-label {
            font-size: 0.75em;
            color: #6c757d;
            margin-top: 2px;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .button-group {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .print-btn {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .clear-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .schedule-container {
            margin-top: 15px;
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: white;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .schedule-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 18px 12px;
            text-align: center;
            font-weight: 700;
            font-size: 15px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            border-bottom: 3px solid #1a252f;
        }

        .schedule-table td {
            padding: 16px 12px;
            text-align: center;
            border-bottom: 1px solid #e8ecf0;
            border-right: 1px solid #e8ecf0;
            vertical-align: top;
            font-size: 13px;
            line-height: 1.5;
            transition: background-color 0.2s ease;
        }

        .schedule-table td:hover {
            background-color: #f8f9fb;
        }

        .time-column {
            background: linear-gradient(135deg, #ecf0f1 0%, #d5dbdb 100%);
            font-weight: 700;
            color: #2c3e50;
            white-space: nowrap;
            min-width: 130px;
            border-right: 2px solid #bdc3c7;
            font-size: 14px;
        }

        .class-cell {
            min-width: 160px;
            position: relative;
        }

        .class-name {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 14px;
            color: #2c3e50;
            line-height: 1.3;
        }

        .teacher-name {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .room-name {
            color: #2c3e50;
            font-size: 11px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Subject color coding - Unique distinct colors */
        .math { background-color: #ffe6e6; border-left: 4px solid #e74c3c; }          /* Red */
        .science { background-color: #e6f3ff; border-left: 4px solid #3498db; }       /* Blue */
        .language-arts { background-color: #f0e6ff; border-left: 4px solid #9b59b6; } /* Purple */
        .social-studies { background-color: #e6ffe6; border-left: 4px solid #27ae60; }/* Green */
        .spanish { background-color: #fff3e6; border-left: 4px solid #f39c12; }       /* Orange */
        .family-consumer { background-color: #ffe6f7; border-left: 4px solid #e91e63; }/* Pink */
        .band { background-color: #e6f7ff; border-left: 4px solid #00bcd4; }          /* Cyan */
        .pe { background-color: #f6ffe6; border-left: 4px solid #8bc34a; }            /* Lime Green */
        .flex { background-color: #f5f5f5; border-left: 4px solid #607d8b; }          /* Blue Grey */
        .homeroom { background-color: #fff7e6; border-left: 4px solid #ff9800; }      /* Amber */
        .lunch { background-color: #ffeaa7; border-left: 4px solid #fdcb6e; }         /* Yellow */
        .unknown { background-color: #f8f9fa; border-left: 4px solid #6c757d; }

        /* Activity styling */
        .activity { background-color: #fff3e6; border-left: 4px solid #ff9500; border: 2px solid #ff9500; }
        .activity-conflict { background: repeating-linear-gradient(45deg, #ffe6e6, #ffe6e6 10px, #fff3e6 10px, #fff3e6 20px); border: 2px solid #dc3545; }
        
        .activity-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-info {
            flex: 1;
        }
        
        .activity-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .activity-details {
            font-size: 0.85em;
            color: #666;
        }
        
        .activity-actions {
            display: flex;
            gap: 5px;
        }
        
        .activity-actions button {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 3px;
        }
        
        .edit-activity-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%) !important;
        }
        
        .delete-activity-btn {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
        }

        /* Modern popup/modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .modal-header p {
            color: #7f8c8d;
            font-size: 1em;
            line-height: 1.5;
        }

        .time-input-group {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .time-input-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: block;
            font-size: 1em;
        }

        .time-input-details {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 12px;
        }

        .time-input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        .time-input-field:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .time-input-field.error {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e9ecef;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }

        .modal-btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .modal-btn-secondary:hover {
            background: #e9ecef;
            color: #495057;
        }

        .time-hint {
            font-size: 0.85em;
            color: #17a2b8;
            margin-top: 4px;
            font-style: italic;
        }

        .student-info {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 18px 25px;
            border-radius: 8px;
            margin-bottom: 18px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(44, 62, 80, 0.3);
            border: 1px solid #34495e;
        }

        .student-info h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: 0.3px;
        }

        .student-info p {
            font-size: 14px;
            opacity: 0.95;
            font-weight: 500;
            margin: 0;
        }

        .legend {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .legend h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #f44336;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
        }

        .filter-inline {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
        }

        .filter-inline label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .filter-inline select {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            min-width: 150px;
            transition: border-color 0.3s;
        }

        .filter-inline select:focus {
            outline: none;
            border-color: #007bff;
        }

        .filter-inline button {
            padding: 6px 12px;
            font-size: 12px;
        }

        .filtered-highlight {
            background: #fff3cd !important;
            border: 2px solid #f0ad4e !important;
            box-shadow: 0 0 10px rgba(240, 173, 78, 0.3) !important;
        }

        .filtered-dim {
            opacity: 0.3 !important;
        }

        .schedule-type {
            font-size: 11px;
            font-weight: bold;
            color: #666;
            display: block;
            margin-top: 2px;
        }

        .schedule-a-row {
            border-top: 2px solid #e0e0e0;
        }

        .schedule-b-row {
            border-bottom: 1px solid #f0f0f0;
        }

        .schedule-b-row .time-column {
            border-top: 1px solid #ddd;
            padding-top: 8px;
        }

        .schedule-merged-row {
            border-top: 2px solid #e0e0e0;
            border-bottom: 2px solid #e0e0e0;
            background-color: #f8f9fa;
        }

        .schedule-merged-row .time-column {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .schedule-merged-row .schedule-type {
            color: #28a745;
            font-weight: bold;
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-family: 'Segoe UI', Arial, sans-serif !important;
                font-size: 11px !important;
                line-height: 1.3 !important;
            }
            
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                max-width: none !important;
                width: 100% !important;
                height: 100vh !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .header {
                display: none !important;
            }
            
            .content {
                padding: 0 !important;
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .control-section,
            .button-group,
            .filter-inline,
            #messageArea {
                display: none !important;
            }
            
            .student-info {
                background: #2c3e50 !important;
                color: white !important;
                border: 3px solid #2c3e50 !important;
                padding: 15px 20px !important;
                margin: 0 0 15px 0 !important;
                text-align: center !important;
                border-radius: 0 !important;
                page-break-inside: avoid !important;
                box-shadow: none !important;
            }

            .student-info h2 {
                font-size: 22px !important;
                font-weight: 700 !important;
                margin: 0 0 5px 0 !important;
                color: white !important;
            }

            .student-info p {
                font-size: 14px !important;
                margin: 0 !important;
                color: white !important;
                font-weight: 500 !important;
            }
            
            .schedule-container {
                margin: 0 !important;
                overflow: visible !important;
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            
            .schedule-table {
                width: 100% !important;
                border-collapse: collapse !important;
                border: 2px solid #2c3e50 !important;
                height: 100% !important;
                font-size: 10px !important;
                font-family: 'Segoe UI', Arial, sans-serif !important;
            }
            
            .schedule-table th {
                background: #2c3e50 !important;
                color: white !important;
                border: 1px solid #2c3e50 !important;
                padding: 8px 6px !important;
                font-weight: 700 !important;
                font-size: 11px !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            .schedule-table td {
                border: 1px solid #34495e !important;
                padding: 6px 4px !important;
                font-size: 9px !important;
                line-height: 1.2 !important;
                page-break-inside: avoid !important;
                vertical-align: top !important;
            }
            
            .time-column {
                background: #ecf0f1 !important;
                font-weight: 700 !important;
                width: 100px !important;
                color: #2c3e50 !important;
                font-size: 10px !important;
                border-right: 2px solid #2c3e50 !important;
            }
            
            .class-cell {
                width: auto !important;
                min-width: 120px !important;
            }
            
            .class-name {
                font-weight: 700 !important;
                font-size: 10px !important;
                margin-bottom: 3px !important;
                color: #2c3e50 !important;
                line-height: 1.2 !important;
            }
            
            .teacher-name {
                font-size: 8px !important;
                margin-bottom: 2px !important;
                color: #7f8c8d !important;
                font-weight: 500 !important;
            }
            
            .room-name {
                font-size: 8px !important;
                color: #2c3e50 !important;
                background: rgba(255, 255, 255, 0.95) !important;
                padding: 1px 4px !important;
                border-radius: 3px !important;
                border: 1px solid rgba(0, 0, 0, 0.15) !important;
                font-weight: 600 !important;
            }
            
            /* Enhanced subject color coding for print */
            .math { background-color: #ffe6e6 !important; border-left: 4px solid #e74c3c !important; }
            .science { background-color: #e6f3ff !important; border-left: 4px solid #3498db !important; }
            .language-arts { background-color: #f0e6ff !important; border-left: 4px solid #9b59b6 !important; }
            .social-studies { background-color: #e6ffe6 !important; border-left: 4px solid #27ae60 !important; }
            .spanish { background-color: #fff3e6 !important; border-left: 4px solid #f39c12 !important; }
            .family-consumer { background-color: #ffe6f7 !important; border-left: 4px solid #e91e63 !important; }
            .band { background-color: #e6f7ff !important; border-left: 4px solid #00bcd4 !important; }
            .pe { background-color: #f6ffe6 !important; border-left: 4px solid #8bc34a !important; }
            .flex { background-color: #f5f5f5 !important; border-left: 4px solid #607d8b !important; }
            .homeroom { background-color: #fff7e6 !important; border-left: 4px solid #ff9800 !important; }
            .lunch { background-color: #ffeaa7 !important; border-left: 4px solid #fdcb6e !important; }
            .unknown { background-color: #f8f9fa !important; border-left: 4px solid #6c757d !important; }
            
            .schedule-type {
                font-size: 8px !important;
                font-weight: 700 !important;
                color: #2c3e50 !important;
                display: block !important;
                margin-top: 2px !important;
            }

            .schedule-a-row {
                border-top: 1px solid #34495e !important;
            }

            .schedule-b-row {
                border-bottom: 1px solid #34495e !important;
            }

            .schedule-merged-row {
                border-top: 2px solid #2c3e50 !important;
                border-bottom: 2px solid #2c3e50 !important;
                background-color: #ecf0f1 !important;
            }

            .schedule-merged-row .time-column {
                background-color: #d5dbdb !important;
                font-weight: 700 !important;
            }

            .schedule-merged-row .schedule-type {
                color: #27ae60 !important;
                font-weight: 700 !important;
            }

            /* Ensure content fills the page */
            .schedule-table tr {
                page-break-inside: avoid !important;
            }
            
            /* Print-optimized legend */
            .legend {
                display: block !important;
                margin-top: 15px !important;
                padding: 10px !important;
                background: white !important;
                border: 1px solid #2c3e50 !important;
                border-radius: 0 !important;
                page-break-inside: avoid !important;
            }

            .legend h3 {
                color: #2c3e50 !important;
                margin-bottom: 8px !important;
                font-size: 12px !important;
                font-weight: 700 !important;
                text-align: center !important;
            }

            .legend-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 4px !important;
                font-size: 8px !important;
            }

            .legend-item {
                display: flex !important;
                align-items: center !important;
                padding: 3px 6px !important;
                border-radius: 3px !important;
                font-size: 8px !important;
                font-weight: 500 !important;
                border: 1px solid #ddd !important;
            }

            /* Print legend colors - same as schedule colors */
            .legend .math { background-color: #ffe6e6 !important; border-left: 3px solid #e74c3c !important; }
            .legend .science { background-color: #e6f3ff !important; border-left: 3px solid #3498db !important; }
            .legend .language-arts { background-color: #f0e6ff !important; border-left: 3px solid #9b59b6 !important; }
            .legend .social-studies { background-color: #e6ffe6 !important; border-left: 3px solid #27ae60 !important; }
            .legend .spanish { background-color: #fff3e6 !important; border-left: 3px solid #f39c12 !important; }
            .legend .family-consumer { background-color: #ffe6f7 !important; border-left: 3px solid #e91e63 !important; }
            .legend .band { background-color: #e6f7ff !important; border-left: 3px solid #00bcd4 !important; }
            .legend .pe { background-color: #f6ffe6 !important; border-left: 3px solid #8bc34a !important; }
            .legend .flex { background-color: #f5f5f5 !important; border-left: 3px solid #607d8b !important; }
            .legend .homeroom { background-color: #fff7e6 !important; border-left: 3px solid #ff9800 !important; }
            .legend .lunch { background-color: #ffeaa7 !important; border-left: 3px solid #fdcb6e !important; }
            .legend .unknown { background-color: #f8f9fa !important; border-left: 3px solid #6c757d !important; }

            /* Optimize page usage */
            @page {
                margin: 0.4in 0.3in !important;
                size: letter !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .button-group {
                justify-content: center;
                flex-direction: column;
                gap: 10px;
            }

            .button-group button {
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }
            
            .schedule-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .schedule-table {
                font-size: 11px;
                min-width: 600px;
            }
            
            .schedule-table th,
            .schedule-table td {
                padding: 10px 6px;
            }

            .class-name {
                font-size: 12px !important;
            }

            .teacher-name {
                font-size: 10px !important;
            }

            .room-name {
                font-size: 9px !important;
            }

            .student-info h2 {
                font-size: 24px !important;
            }

            .student-info p {
                font-size: 14px !important;
            }

            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-controls select {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Smart School Schedule</h1>
            <p>Transform messy school schedules into beautiful, easy-to-read tables</p>
        </div>
        
        <div class="content">
            <div class="control-section" id="importSection">
                <h2>üìã Import Your Schedule</h2>
                <p>Copy and paste your child's schedule from Infinite Campus below.</p>
                
                <textarea id="scheduleInput" placeholder="Paste your Infinite Campus schedule here..."></textarea>
                
                <div class="button-group">
                    <button onclick="parseSchedule()">üìä Create Schedule Table</button>
                    <button onclick="loadSampleData()">üìù Load Sample Data</button>
                    <button class="print-btn" onclick="printSchedule()" id="printBtn" style="display: none;">üñ®Ô∏è Print</button>
                    <button class="clear-btn" onclick="clearAll()">üóëÔ∏è Clear</button>
                </div>
            </div>

            <div class="control-section" id="scheduleLoadedSection" style="display: none;">
                <h2>üìã Schedule Ready</h2>
                <p>Your schedule is loaded! Print it, filter by subject, add activities, or upload a new one.</p>
                
                <div class="button-group">
                    <button class="print-btn" onclick="printSchedule()">üñ®Ô∏è Print Schedule</button>
                    <button onclick="showActivitySection()" style="background: linear-gradient(135deg, #ff9500 0%, #ffad33 100%);">‚öΩ Add Activities</button>
                    <button onclick="showImportSection()">üìù Upload New</button>
                    <button class="clear-btn" onclick="clearAll()">üóëÔ∏è Clear All</button>
                </div>
                
                <div class="filter-inline" id="filterInline" style="display: none;">
                    <label>Filter:</label>
                    <select id="subjectFilter" onchange="applyFilter()">
                        <option value="">Show All Subjects</option>
                    </select>
                    <button onclick="clearFilter()" class="clear-btn">Clear</button>
                </div>
                
                <div class="schedule-info" id="scheduleInfo">
                    <!-- Schedule info will be populated here -->
                </div>
            </div>

            <div class="control-section" id="activitySection" style="display: none;">
                <h2>‚öΩ Add Extracurricular Activities</h2>
                <p>Add recurring activities like sports, clubs, and after-school programs to your schedule.</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Activity Name:</label>
                        <input type="text" id="activityName" placeholder="e.g., Soccer Practice, Chess Club" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Time:</label>
                        <input type="text" id="activityTime" placeholder="e.g., 3:30 PM - 5:00 PM" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Days of the Week:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" id="dayMon" value="Mon"> Monday</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" id="dayTue" value="Tues"> Tuesday</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" id="dayWed" value="Weds"> Wednesday</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" id="dayThu" value="Thurs"> Thursday</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" id="dayFri" value="Fri"> Friday</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" id="daySat" value="Sat"> Saturday</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" id="daySun" value="Sun"> Sunday</label>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="addActivity()" style="background: linear-gradient(135deg, #28a745 0%, #32cd32 100%);">‚úÖ Add Activity</button>
                    <button onclick="hideActivitySection()">‚ùå Cancel</button>
                </div>
                
                <div id="activitiesList" style="margin-top: 20px;">
                    <h3 style="color: #333; margin-bottom: 10px;">üìã Current Activities</h3>
                    <div id="activitiesContainer"></div>
                </div>
            </div>

            <div id="messageArea"></div>
            <div id="scheduleDisplay"></div>
        </div>
    </div>

    <script>
        let scheduleData = {};
        let studentInfo = {};
        let activities = [];

        function parseTime(timeStr) {
            // Convert time string to minutes since midnight
            // Handles: "8:10 AM", "1:53 PM", "13:53", "01:53" (ambiguous format)
            const trimmed = timeStr.trim();
            
            // Check if it has AM/PM
            if (trimmed.includes('AM') || trimmed.includes('PM')) {
                const [time, period] = trimmed.split(' ');
                const [hours, minutes] = time.split(':').map(Number);
                
                let hour24 = hours;
                if (period.toUpperCase() === 'PM' && hours !== 12) {
                    hour24 += 12;
                } else if (period.toUpperCase() === 'AM' && hours === 12) {
                    hour24 = 0;
                }
                
                return hour24 * 60 + minutes;
            }
            
            // Handle 24-hour format or ambiguous format
            const [hours, minutes] = trimmed.split(':').map(Number);
            
            // If it's clearly 24-hour format (> 12 hours), use as-is
            if (hours > 12) {
                return hours * 60 + minutes;
            }
            
            // If it's 24-hour format in morning range (0-6), use as-is
            if (hours >= 0 && hours <= 6) {
                return hours * 60 + minutes;
            }
            
            // For ambiguous times (1-12), apply school schedule logic
            return smartTimeConversion(hours, minutes);
        }

        function smartTimeConversion(hours, minutes) {
            // Intelligently convert ambiguous times based on school schedule patterns
            // Schools typically run 7:00 AM - 8:00 PM (07:00 - 20:00)
            
            // Early morning times (7-11) are typically AM
            if (hours >= 7 && hours <= 11) {
                return hours * 60 + minutes;
            }
            
            // 12 o'clock handling
            if (hours === 12) {
                // 12:XX during school hours is typically 12:XX PM (noon)
                return 12 * 60 + minutes;
            }
            
            // Afternoon times (1-6) during school hours should be PM
            if (hours >= 1 && hours <= 6) {
                return (hours + 12) * 60 + minutes;
            }
            
            // Default fallback - if unclear, assume PM for school context
            return (hours + 12) * 60 + minutes;
        }

        function minutesToTimeString(minutes) {
            // Convert minutes since midnight back to time string
            let hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            const period = hours >= 12 ? 'PM' : 'AM';
            
            if (hours > 12) hours -= 12;
            if (hours === 0) hours = 12;
            
            return `${hours}:${mins.toString().padStart(2, '0')} ${period}`;
        }

        function normalizeTimeRange(timeRangeStr) {
            // Normalize time ranges like "01:53 - 02:50" to "1:53 PM - 2:50 PM"
            if (!timeRangeStr || !timeRangeStr.includes('-')) {
                return timeRangeStr;
            }
            
            // If it already has AM/PM, return as-is
            if (timeRangeStr.includes('AM') || timeRangeStr.includes('PM')) {
                return timeRangeStr;
            }
            
            // Split the time range
            const [startTime, endTime] = timeRangeStr.split('-').map(t => t.trim());
            
            // Parse and convert each time
            const startMinutes = parseTime(startTime);
            const endMinutes = parseTime(endTime);
            
            // Convert back to readable format
            const normalizedStart = minutesToTimeString(startMinutes);
            const normalizedEnd = minutesToTimeString(endMinutes);
            
            return `${normalizedStart} - ${normalizedEnd}`;
        }

        function extractPeriodTime(periodStr) {
            // Extract time from period string like "Period 08:23", "Period 1:53", or "Period HR"
            const timeMatch = periodStr.match(/Period\s+(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                const [, hours, minutes] = timeMatch;
                
                // Use smart time conversion for ambiguous formats
                const timeString = `${hours}:${minutes}`;
                const totalMinutes = parseTime(timeString);
                return minutesToTimeString(totalMinutes);
            }
            
            // Handle special periods like "Period HR" - return null to trigger user input
            return null;
        }

        function calculateMissingTimes() {
            // Track periods that need user input for times
            const periodsNeedingTimes = [];
            
            // Calculate time ranges for periods that don't have explicit times
            Object.keys(scheduleData).forEach(dayKey => {
                const daySchedule = scheduleData[dayKey];
                
                for (let i = 0; i < daySchedule.length; i++) {
                    const period = daySchedule[i];
                    
                    if (period.needsTimeCalculation) {
                        const startTime = extractPeriodTime(period.period);
                        
                        if (startTime) {
                            let endTime = null;
                            
                            // Find the next period's start time
                            for (let j = i + 1; j < daySchedule.length; j++) {
                                const nextPeriod = daySchedule[j];
                                const nextStartTime = extractPeriodTime(nextPeriod.period);
                                if (nextStartTime) {
                                    endTime = nextStartTime;
                                    break;
                                }
                            }
                            
                            // If no next period found, assume 57-minute class duration (typical)
                            if (!endTime) {
                                const startMinutes = parseTime(startTime);
                                const endMinutes = startMinutes + 57; // Default class length
                                endTime = minutesToTimeString(endMinutes);
                            }
                            
                            period.time = `${startTime} - ${endTime}`;
                            console.log(`Calculated time for ${period.subject}: ${period.time}`);
                        } else {
                            // Can't extract time from period name, need user input
                            periodsNeedingTimes.push({
                                day: dayKey,
                                period: period.period,
                                subject: period.subject,
                                index: i
                            });
                        }
                        
                        // Remove the flag
                        delete period.needsTimeCalculation;
                    }
                }
            });
            
            // Prompt user for missing times
            if (periodsNeedingTimes.length > 0) {
                promptForMissingTimes(periodsNeedingTimes);
            }
        }

        function promptForMissingTimes(periodsNeedingTimes) {
            showTimeInputModal(periodsNeedingTimes);
        }

        function showTimeInputModal(periodsNeedingTimes) {
            // Create modal HTML
            const modalHTML = `
                <div class="modal-overlay" id="timeInputModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>‚è∞ Missing Time Information</h2>
                            <p>Some periods don't have start times. Please provide them below, or use our smart defaults.</p>
                        </div>
                        
                        <div id="timeInputFields">
                            ${periodsNeedingTimes.map((periodInfo, index) => `
                                <div class="time-input-group">
                                    <label class="time-input-label">
                                        ${periodInfo.day} - ${periodInfo.period}
                                    </label>
                                    <div class="time-input-details">
                                        Subject: ${periodInfo.subject}
                                    </div>
                                    <input type="text" 
                                           class="time-input-field" 
                                           id="timeInput${index}"
                                           placeholder="8:15 AM"
                                           data-index="${index}">
                                    <div class="time-hint">Example: 8:15 AM, 1:53 PM, or 13:53 (any format works!)</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="modal-buttons">
                            <button class="modal-btn modal-btn-secondary" onclick="useDefaultTimes()">
                                Use Smart Defaults
                            </button>
                            <button class="modal-btn modal-btn-primary" onclick="submitCustomTimes()">
                                Apply Times
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Store periods data for later use
            window.currentPeriodsNeedingTimes = periodsNeedingTimes;
            
            // Focus first input and add keyboard support
            setTimeout(() => {
                const firstInput = document.getElementById('timeInput0');
                if (firstInput) firstInput.focus();
                
                // Add keyboard event listeners
                document.addEventListener('keydown', handleModalKeydown);
                
                // Add enter key support for inputs
                const inputs = document.querySelectorAll('.time-input-field');
                inputs.forEach((input, index) => {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const nextInput = document.getElementById(`timeInput${index + 1}`);
                            if (nextInput) {
                                nextInput.focus();
                            } else {
                                submitCustomTimes();
                            }
                        }
                    });
                });
            }, 100);
        }

        function handleModalKeydown(e) {
            if (e.key === 'Escape') {
                useDefaultTimes();
            }
        }

        function submitCustomTimes() {
            const periodsNeedingTimes = window.currentPeriodsNeedingTimes;
            const times = [];
            let hasErrors = false;
            
            // Collect and validate times
            for (let i = 0; i < periodsNeedingTimes.length; i++) {
                const input = document.getElementById(`timeInput${i}`);
                const value = input.value.trim();
                
                if (value) {
                    // Basic validation for time format
                    if (isValidTimeFormat(value)) {
                        times.push(value);
                        input.classList.remove('error');
                    } else {
                        input.classList.add('error');
                        hasErrors = true;
                    }
                } else {
                    times.push(null); // Empty = use default
                    input.classList.remove('error');
                }
            }
            
            if (hasErrors) {
                showMessage('Please check the highlighted time formats. Use formats like "8:15 AM", "1:53 PM", or "13:53".', 'error');
                return;
            }
            
            // Close modal and apply times
            closeTimeInputModal();
            applyUserProvidedTimes(periodsNeedingTimes, times);
        }

        function useDefaultTimes() {
            const periodsNeedingTimes = window.currentPeriodsNeedingTimes;
            closeTimeInputModal();
            assignDefaultTimes(periodsNeedingTimes);
            showMessage('Smart default times have been applied to your schedule! üéâ', 'success');
        }

        function closeTimeInputModal() {
            const modal = document.getElementById('timeInputModal');
            if (modal) {
                modal.remove();
            }
            // Clean up event listeners
            document.removeEventListener('keydown', handleModalKeydown);
            window.currentPeriodsNeedingTimes = null;
        }

        function isValidTimeFormat(timeStr) {
            // Check for various time formats:
            // - H:MM AM/PM or HH:MM AM/PM (12-hour with AM/PM)
            // - H:MM or HH:MM (ambiguous/24-hour format - will be auto-converted)
            const timePattern12Hour = /^(0?[1-9]|1[0-2]):[0-5][0-9]\s?(AM|PM)$/i;
            const timePatternAmbiguous = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            
            const trimmed = timeStr.trim();
            return timePattern12Hour.test(trimmed) || timePatternAmbiguous.test(trimmed);
        }

        function applyUserProvidedTimes(periodsNeedingTimes, times) {
            periodsNeedingTimes.forEach((periodInfo, index) => {
                const userTime = times[index];
                const daySchedule = scheduleData[periodInfo.day];
                const period = daySchedule[periodInfo.index];
                
                if (userTime) {
                    // Use user-provided time (normalize it to handle ambiguous formats)
                    const startMinutes = parseTime(userTime);
                    const endMinutes = startMinutes + 57; // Default 57-minute duration
                    const normalizedStartTime = minutesToTimeString(startMinutes);
                    const endTime = minutesToTimeString(endMinutes);
                    period.time = `${normalizedStartTime} - ${endTime}`;
                    console.log(`User provided time for ${period.subject}: ${period.time}`);
                } else {
                    // Use a reasonable default based on position
                    assignDefaultTime(period, periodInfo.index);
                }
            });
            
            // Refresh the display with updated times
            displaySchedule();
        }

        function assignDefaultTimes(periodsNeedingTimes) {
            periodsNeedingTimes.forEach(periodInfo => {
                const daySchedule = scheduleData[periodInfo.day];
                const period = daySchedule[periodInfo.index];
                assignDefaultTime(period, periodInfo.index);
            });
        }

        function assignDefaultTime(period, index) {
            // Assign reasonable default times based on period position
            const defaultStartTimes = [
                "7:45 AM", // Period 0 (HR)
                "8:23 AM", // Period 1
                "9:20 AM", // Period 2
                "10:23 AM", // Period 3
                "11:23 AM", // Period 4
                "12:23 PM", // Period 5
                "1:23 PM",  // Period 6
                "2:23 PM",  // Period 7
                "3:23 PM"   // Period 8
            ];
            
            const startTime = defaultStartTimes[index] || defaultStartTimes[defaultStartTimes.length - 1];
            const startMinutes = parseTime(startTime);
            const endMinutes = startMinutes + 57;
            const endTime = minutesToTimeString(endMinutes);
            
            period.time = `${startTime} - ${endTime}`;
            console.log(`Default time assigned for ${period.subject}: ${period.time}`);
        }

        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error-message' : 'success-message';
            messageArea.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function getSubjectClass(subject) {
            const subjectLower = subject.toLowerCase();
            
            // Core subjects
            if (subjectLower.includes('math') || subjectLower.includes('algebra') || subjectLower.includes('geometry') || subjectLower.includes('calculus')) return 'math';
            if (subjectLower.includes('science') && !subjectLower.includes('family') && !subjectLower.includes('consumer')) return 'science';
            if (subjectLower.includes('biology') || subjectLower.includes('chemistry') || subjectLower.includes('physics')) return 'science';
            if (subjectLower.includes('language arts') || subjectLower.includes('english') || subjectLower.includes('reading') || subjectLower.includes('writing')) return 'language-arts';
            if (subjectLower.includes('social studies') || subjectLower.includes('history') || subjectLower.includes('geography') || subjectLower.includes('civics')) return 'social-studies';
            
            // World languages
            if (subjectLower.includes('spanish') || subjectLower.includes('french') || subjectLower.includes('german') || subjectLower.includes('italian') || subjectLower.includes('chinese') || subjectLower.includes('japanese')) return 'spanish';
            
            // Electives and specials
            if (subjectLower.includes('family') || subjectLower.includes('consumer') || subjectLower.includes('art') || subjectLower.includes('drama') || subjectLower.includes('theater')) return 'family-consumer';
            if (subjectLower.includes('band') || subjectLower.includes('orchestra') || subjectLower.includes('choir') || subjectLower.includes('music')) return 'band';
            if (subjectLower.includes('pe') || subjectLower.includes('gym') || subjectLower.includes('physical education') || subjectLower.includes('health')) return 'pe';
            
            // School-specific
            if (subjectLower.includes('flex') || subjectLower.includes('study hall') || subjectLower.includes('advisory')) return 'flex';
            if (subjectLower.includes('homeroom') || subjectLower.includes('hr')) return 'homeroom';
            if (subjectLower.includes('lunch') || subjectLower.includes('breakfast')) return 'lunch';
            
            // Return 'unknown' for any unrecognized subjects
            return 'unknown';
        }

        // State management functions
        function saveState() {
            const state = {
                scheduleData: scheduleData,
                studentInfo: studentInfo,
                inputData: document.getElementById('scheduleInput').value,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('scheduleViewerState', JSON.stringify(state));
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('scheduleViewerState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    scheduleData = state.scheduleData || {};
                    studentInfo = state.studentInfo || {};
                    
                    if (state.inputData) {
                        document.getElementById('scheduleInput').value = state.inputData;
                    }
                    
                    if (Object.keys(scheduleData).length > 0) {
                        displaySchedule();
                        populateSubjectFilter();
                        showScheduleLoadedState();
                        showMessage('Previously saved schedule loaded! üìã', 'success');
                    }
                }
            } catch (error) {
                console.error('Error loading saved state:', error);
            }
        }

        function parseSchedule() {
            const input = document.getElementById('scheduleInput').value.trim();
            
            if (!input) {
                showMessage('Please paste your schedule data first.', 'error');
                return;
            }

            try {
                // Clean input: remove empty lines and extra whitespace
                const lines = input.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0); // Remove empty lines
                
                scheduleData = {};
                studentInfo = {};
                
                let currentDay = '';
                let currentPeriod = null;
                let i = 0;

                // Parse student info
                while (i < lines.length) {
                    const line = lines[i];
                    if (line.startsWith('Selected student:')) {
                        studentInfo.name = line.replace('Selected student:', '').trim();
                    } else if (line.match(/^\d{2}-\d{2}/)) {
                        studentInfo.school = line;
                    } else if (line.startsWith('Day:')) {
                        break;
                    }
                    i++;
                }

                // Parse schedule data
                while (i < lines.length) {
                    const line = lines[i];
                    
                    if (line.startsWith('Day:')) {
                        currentDay = line.replace('Day:', '').trim();
                        scheduleData[currentDay] = [];
                    } else if (line.startsWith('Period')) {
                        currentPeriod = {
                            period: line,
                            subject: '',
                            time: '',
                            teacher: '',
                            room: ''
                        };
                        
                        // Get subject (next line)
                        if (i + 1 < lines.length) {
                            i++;
                            currentPeriod.subject = lines[i].trim();
                        }
                        
                        // Look ahead to find time range, teacher, and room info
                        let hasExplicitTime = false;
                        let lookAheadIndex = i + 1;
                        
                        // Scan the next few lines to find time, teacher, and room
                        while (lookAheadIndex < lines.length) {
                            const lookAheadLine = lines[lookAheadIndex];
                            
                            // Stop if we hit another period or day
                            if (lookAheadLine.startsWith('Period') || lookAheadLine.startsWith('Day:')) {
                                break;
                            }
                            
                            // Check for time range (explicit with AM/PM or ambiguous format)
                            if (!hasExplicitTime && lookAheadLine.includes('-')) {
                                // Check if it looks like a time range (contains colons and dash)
                                const timeRangePattern = /(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/;
                                if (timeRangePattern.test(lookAheadLine) || 
                                    (lookAheadLine.includes('AM') || lookAheadLine.includes('PM'))) {
                                    // Normalize the time range to handle ambiguous formats
                                    currentPeriod.time = normalizeTimeRange(lookAheadLine);
                                    hasExplicitTime = true;
                                }
                            }
                            
                            // Check for teacher
                            if (lookAheadLine.startsWith('Teacher:')) {
                                currentPeriod.teacher = lookAheadLine.replace('Teacher:', '').trim();
                            }
                            
                            // Check for room
                            if (lookAheadLine.startsWith('Room:')) {
                                currentPeriod.room = lookAheadLine.replace('Room:', '').trim();
                            }
                            
                            lookAheadIndex++;
                        }
                        
                        // Update the main index to skip the processed lines
                        i = lookAheadIndex - 1;
                        
                        // If no explicit time was found, we'll calculate it later
                        if (!hasExplicitTime) {
                            currentPeriod.needsTimeCalculation = true;
                        }
                        
                        // Only add the period if it has valid data
                        if (currentDay && 
                            currentPeriod && 
                            currentPeriod.subject && 
                            currentPeriod.subject.trim().length > 0 &&
                            !currentPeriod.subject.toLowerCase().includes('undefined') &&
                            currentPeriod.subject !== '-' &&
                            currentPeriod.subject !== 'null') {
                            
                            // Clean up any remaining whitespace or special characters
                            currentPeriod.subject = currentPeriod.subject.trim();
                            currentPeriod.teacher = currentPeriod.teacher.trim();
                            currentPeriod.room = currentPeriod.room.trim();
                            
                            // Additional validation: don't add periods with empty/meaningless content
                            if (currentPeriod.subject.length > 0) {
                                scheduleData[currentDay].push(currentPeriod);
                            }
                        }
                    }
                    i++;
                }

                // Calculate missing time ranges for Format 2
                calculateMissingTimes();

                // Final cleanup: remove any periods that ended up with invalid data
                Object.keys(scheduleData).forEach(day => {
                    const beforeCount = scheduleData[day].length;
                    scheduleData[day] = scheduleData[day].filter(period => {
                        const isValid = period.time && 
                                       period.time.includes('-') && 
                                       period.subject && 
                                       period.subject.trim().length > 0 &&
                                       period.time.trim() !== '-' &&
                                       !period.subject.toLowerCase().includes('undefined');
                        
                        if (!isValid) {
                            console.log(`Removing invalid period from ${day}:`, period);
                        }
                        return isValid;
                    });
                    const afterCount = scheduleData[day].length;
                    if (beforeCount !== afterCount) {
                        console.log(`Cleaned ${day}: removed ${beforeCount - afterCount} invalid periods`);
                    }
                });

                displaySchedule();
                saveState(); // Save the schedule data
                populateSubjectFilter(); // Populate the filter dropdown
                showScheduleLoadedState(); // Switch to loaded state
                showMessage('Schedule imported successfully! üéâ');
                
            } catch (error) {
                console.error('Parse error:', error);
                showMessage('Error parsing schedule. Please check the format and try again.', 'error');
            }
        }

        function displaySchedule() {
            const displayArea = document.getElementById('scheduleDisplay');
            
            if (Object.keys(scheduleData).length === 0 && activities.length === 0) {
                displayArea.innerHTML = '';
                return;
            }

            // If we only have activities (no school schedule), display activities-only view
            if (Object.keys(scheduleData).length === 0 && activities.length > 0) {
                displayActivitiesOnlySchedule();
                return;
            }

            // Create student info section
            let html = '';
            if (studentInfo.name || studentInfo.school) {
                html += `
                    <div class="student-info">
                        <h2>üë®‚Äçüéì ${studentInfo.name || 'Student Schedule'}</h2>
                        <p>${studentInfo.school || ''}</p>
                    </div>
                `;
            }

            // Group days by base name (Mon, Tues, Weds, etc.) and schedule type (A or B)
            const groupedDays = {};
            Object.keys(scheduleData).forEach(dayKey => {
                const match = dayKey.match(/^(.*?)\.\s*([AB])$/);
                if (match) {
                    const [, dayName, scheduleType] = match;
                    if (!groupedDays[dayName]) {
                        groupedDays[dayName] = {};
                    }
                    groupedDays[dayName][scheduleType] = scheduleData[dayKey];
                }
            });

            // Get all unique times across all days
            const allTimes = new Set();
            Object.values(scheduleData).forEach(daySchedule => {
                daySchedule.forEach(period => {
                    // Only include periods with valid time data AND meaningful content
                    if (period.time && 
                        period.time.includes('-') && 
                        period.subject && 
                        period.subject.trim().length > 0 &&
                        !period.subject.toLowerCase().includes('undefined') &&
                        period.time.trim() !== '-') {
                        allTimes.add(period.time);
                    }
                });
            });

            const sortedTimes = Array.from(allTimes).sort((a, b) => {
                const timeA = a.split(' - ')[0];
                const timeB = b.split(' - ')[0];
                return parseTime(timeA) - parseTime(timeB);
            });

            // Create table
            html += '<div class="schedule-container">';
            html += '<table class="schedule-table">';
            
            // Header row
            html += '<tr><th class="time-column">Time</th>';
            Object.keys(groupedDays).forEach(dayName => {
                html += `<th>${dayName}</th>`;
            });
            html += '</tr>';

            // Get all activity times and add them to the sorted times
            const activityTimes = new Set();
            activities.forEach(activity => {
                if (activity.time && activity.time.includes('-')) {
                    activityTimes.add(activity.time);
                }
            });
            
            // Combine school times and activity times
            const allTimeSlots = new Set([...sortedTimes, ...activityTimes]);
            const finalSortedTimes = Array.from(allTimeSlots).sort((a, b) => {
                const timeA = a.split(' - ')[0];
                const timeB = b.split(' - ')[0];
                return parseTime(timeA) - parseTime(timeB);
            });

            // Data rows
            finalSortedTimes.forEach(time => {
                
                // Check if A and B schedules are identical for this time across all days
                let allDaysIdentical = true;
                const dayComparisons = {};
                
                Object.keys(groupedDays).forEach(dayName => {
                    const dayData = groupedDays[dayName];
                    const aPeriod = dayData.A ? dayData.A.find(p => p.time === time) : null;
                    const bPeriod = dayData.B ? dayData.B.find(p => p.time === time) : null;
                    
                    // Compare periods (consider null/undefined as empty)
                    const aSubject = aPeriod ? aPeriod.subject : '';
                    const aTeacher = aPeriod ? aPeriod.teacher : '';
                    const aRoom = aPeriod ? aPeriod.room : '';
                    
                    const bSubject = bPeriod ? bPeriod.subject : '';
                    const bTeacher = bPeriod ? bPeriod.teacher : '';
                    const bRoom = bPeriod ? bPeriod.room : '';
                    
                    const identical = (aSubject === bSubject && aTeacher === bTeacher && aRoom === bRoom);
                    dayComparisons[dayName] = { identical, aPeriod, bPeriod };
                    
                    if (!identical) {
                        allDaysIdentical = false;
                    }
                });

                if (allDaysIdentical) {
                    // Single merged row when A and B are identical
                    html += '<tr class="schedule-merged-row">';
                    html += `<td class="time-column">${time}<br><span class="schedule-type">A & B</span></td>`;
                    
                    Object.keys(groupedDays).forEach(dayName => {
                        const comparison = dayComparisons[dayName];
                        const period = comparison.aPeriod || comparison.bPeriod; // Use whichever exists
                        
                        // Check for activities on this day and time
                        const dayActivities = activities.filter(activity => {
                            const dayMatch = activity.days.includes(dayName);
                            const timeMatch = checkTimeMatch(time, activity.time);

                            return dayMatch && timeMatch;
                        });
                        
                        if (period && dayActivities.length > 0) {
                            // Conflict: both school and activity
                            const subjectClass = getSubjectClass(period.subject);
                            html += `<td class="class-cell activity-conflict">
                                <div class="class-name">${period.subject}</div>
                                <div class="teacher-name">${period.teacher}</div>
                                <div class="room-name">${period.room}</div>
                                <div style="margin-top: 4px; padding: 2px 4px; background: rgba(255,149,0,0.2); border-radius: 3px; font-size: 10px; color: #ff6600;">
                                    ‚ö†Ô∏è ${dayActivities[0].name}
                                </div>
                            </td>`;
                        } else if (period) {
                            // Regular school period
                            const subjectClass = getSubjectClass(period.subject);
                            html += `<td class="class-cell ${subjectClass}">
                                <div class="class-name">${period.subject}</div>
                                <div class="teacher-name">${period.teacher}</div>
                                <div class="room-name">${period.room}</div>
                            </td>`;
                        } else if (dayActivities.length > 0) {
                            // Activity only (no school conflict)
                            html += `<td class="class-cell activity">
                                <div class="class-name">${dayActivities[0].name}</div>
                                <div class="teacher-name">Extracurricular Activity</div>
                                <div class="room-name">${dayActivities[0].time}</div>
                            </td>`;
                        } else {
                            html += '<td class="class-cell">-</td>';
                        }
                    });
                    html += '</tr>';
                } else {
                    // Separate A and B rows when they differ
                    // A Schedule row
                    html += '<tr class="schedule-a-row">';
                    html += `<td class="time-column">${time}<br><span class="schedule-type">A</span></td>`;
                    
                    Object.keys(groupedDays).forEach(dayName => {
                        const comparison = dayComparisons[dayName];
                        const aPeriod = comparison.aPeriod;
                        
                        // Check for activities on this day and time
                        const dayActivities = activities.filter(activity => {
                            const dayMatch = activity.days.includes(dayName);
                            const timeMatch = checkTimeMatch(time, activity.time);

                            return dayMatch && timeMatch;
                        });
                        
                        if (aPeriod && dayActivities.length > 0) {
                            // Conflict: both school and activity
                            const subjectClass = getSubjectClass(aPeriod.subject);
                            html += `<td class="class-cell activity-conflict">
                                <div class="class-name">${aPeriod.subject}</div>
                                <div class="teacher-name">${aPeriod.teacher}</div>
                                <div class="room-name">${aPeriod.room}</div>
                                <div style="margin-top: 4px; padding: 2px 4px; background: rgba(255,149,0,0.2); border-radius: 3px; font-size: 10px; color: #ff6600;">
                                    ‚ö†Ô∏è ${dayActivities[0].name}
                                </div>
                            </td>`;
                        } else if (aPeriod) {
                            const subjectClass = getSubjectClass(aPeriod.subject);
                            html += `<td class="class-cell ${subjectClass}">
                                <div class="class-name">${aPeriod.subject}</div>
                                <div class="teacher-name">${aPeriod.teacher}</div>
                                <div class="room-name">${aPeriod.room}</div>
                            </td>`;
                        } else if (dayActivities.length > 0) {
                            // Activity only (no school conflict)
                            html += `<td class="class-cell activity">
                                <div class="class-name">${dayActivities[0].name}</div>
                                <div class="teacher-name">Extracurricular Activity</div>
                                <div class="room-name">${dayActivities[0].time}</div>
                            </td>`;
                        } else {
                            html += '<td class="class-cell">-</td>';
                        }
                    });
                    html += '</tr>';

                    // B Schedule row
                    html += '<tr class="schedule-b-row">';
                    html += `<td class="time-column"><span class="schedule-type">B</span></td>`;
                    
                    Object.keys(groupedDays).forEach(dayName => {
                        const comparison = dayComparisons[dayName];
                        const bPeriod = comparison.bPeriod;
                        
                        // Check for activities on this day and time
                        const dayActivities = activities.filter(activity => {
                            const dayMatch = activity.days.includes(dayName);
                            const timeMatch = checkTimeMatch(time, activity.time);

                            return dayMatch && timeMatch;
                        });
                        
                        if (bPeriod && dayActivities.length > 0) {
                            // Conflict: both school and activity
                            const subjectClass = getSubjectClass(bPeriod.subject);
                            html += `<td class="class-cell activity-conflict">
                                <div class="class-name">${bPeriod.subject}</div>
                                <div class="teacher-name">${bPeriod.teacher}</div>
                                <div class="room-name">${bPeriod.room}</div>
                                <div style="margin-top: 4px; padding: 2px 4px; background: rgba(255,149,0,0.2); border-radius: 3px; font-size: 10px; color: #ff6600;">
                                    ‚ö†Ô∏è ${dayActivities[0].name}
                                </div>
                            </td>`;
                        } else if (bPeriod) {
                            const subjectClass = getSubjectClass(bPeriod.subject);
                            html += `<td class="class-cell ${subjectClass}">
                                <div class="class-name">${bPeriod.subject}</div>
                                <div class="teacher-name">${bPeriod.teacher}</div>
                                <div class="room-name">${bPeriod.room}</div>
                            </td>`;
                        } else if (dayActivities.length > 0) {
                            // Activity only (no school conflict)
                            html += `<td class="class-cell activity">
                                <div class="class-name">${dayActivities[0].name}</div>
                                <div class="teacher-name">Extracurricular Activity</div>
                                <div class="room-name">${dayActivities[0].time}</div>
                            </td>`;
                        } else {
                            html += '<td class="class-cell">-</td>';
                        }
                    });
                    html += '</tr>';
                }
            });

            html += '</table>';
            html += '</div>';

            // Add legend
            html += `
                <div class="legend">
                    <h3>üé® Color Legend</h3>
                    <div class="legend-grid">
                        <div class="legend-item math">üìê Math</div>
                        <div class="legend-item science">üî¨ Science</div>
                        <div class="legend-item language-arts">üìñ Language Arts</div>
                        <div class="legend-item social-studies">üåç Social Studies</div>
                        <div class="legend-item spanish">üá´üá∑ French</div>
                        <div class="legend-item family-consumer">üè† Family & Consumer Science</div>
                        <div class="legend-item band">üéµ Band</div>
                        <div class="legend-item pe">‚öΩ Physical Education</div>
                        <div class="legend-item flex">üìö FLEX</div>
                        <div class="legend-item homeroom">üè´ Homeroom</div>
                        <div class="legend-item lunch">üçΩÔ∏è Lunch</div>
                        <div class="legend-item activity">‚öΩ Activities</div>
                        <div class="legend-item activity-conflict">‚ö†Ô∏è Conflicts</div>
                        <div class="legend-item unknown">‚ùì Other Subjects</div>
                    </div>
                </div>
            `;

            displayArea.innerHTML = html;
        }

        function loadSampleData() {
            const sampleData = `Schedule
Selected student: Emma Johnson
24-25 Riverside Middle School
Enrollment
24-25 Riverside Middle School
Term 1(08/28/2024 - 10/03/2024)
Day: Mon. A
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Math 6
8:23 AM - 9:20 AM
Teacher: MITCHELL
Room: B128
Period 09:23
Social Studies 6
9:23 AM - 10:20 AM
Teacher: ANDERSON
Room: B130
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
French 1A
10:53 AM - 11:20 AM
Teacher: GARCIA
Room: B125
Period 11:23
French 1A
11:23 AM - 11:50 AM
Teacher: GARCIA
Room: B125
Period 11:53
Family & Consumer Science 6
11:53 AM - 12:20 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:23
Family & Consumer Science 6
12:23 PM - 12:50 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:53
Band 6 5x
12:53 PM - 1:50 PM
Teacher: Wilson, David
Room: C156
Period 01:53
Science 6
1:53 PM - 2:50 PM
Teacher: PATEL
Room: B131
Day: Tues. A
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Language Arts 6
8:23 AM - 9:20 AM
Teacher: RODRIGUEZ
Room: B121
Period 09:23
French 1A
9:23 AM - 10:20 AM
Teacher: GARCIA
Room: B125
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
FLEX 6
10:53 AM - 11:20 AM
Teacher: ANDERSON
Room: B130
Period 11:23
FLEX 6
11:23 AM - 11:50 AM
Teacher: ANDERSON
Room: B130
Period 11:53
Family & Consumer Science 6
11:53 AM - 12:20 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:23
Family & Consumer Science 6
12:23 PM - 12:50 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:53
Band 6 5x
12:53 PM - 1:50 PM
Teacher: Wilson, David
Room: C156
Period 01:53
Science 6
1:53 PM - 2:50 PM
Teacher: PATEL
Room: B131
Day: Weds. A
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Language Arts 6
8:23 AM - 9:20 AM
Teacher: RODRIGUEZ
Room: B121
Period 09:23
Math 6
9:23 AM - 10:20 AM
Teacher: MITCHELL
Room: B128
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
Social Studies 6
10:53 AM - 11:20 AM
Teacher: ANDERSON
Room: B130
Period 11:23
Social Studies 6
11:23 AM - 11:50 AM
Teacher: ANDERSON
Room: B130
Period 11:53
Family & Consumer Science 6
11:53 AM - 12:20 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:23
Family & Consumer Science 6
12:23 PM - 12:50 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:53
PE 6
12:53 PM - 1:50 PM
Teacher: CLARK, J.
Room: Gym
Period 01:53
Science 6
1:53 PM - 2:50 PM
Teacher: PATEL
Room: B131
Day: Thurs. A
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Language Arts 6
8:23 AM - 9:20 AM
Teacher: RODRIGUEZ
Room: B121
Period 09:23
Math 6
9:23 AM - 10:20 AM
Teacher: MITCHELL
Room: B128
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
Social Studies 6
10:53 AM - 11:20 AM
Teacher: ANDERSON
Room: B130
Period 11:23
Social Studies 6
11:23 AM - 11:50 AM
Teacher: ANDERSON
Room: B130
Period 11:53
French 1A
11:53 AM - 12:20 PM
Teacher: GARCIA
Room: B125
Period 12:23
French 1A
12:23 PM - 12:50 PM
Teacher: GARCIA
Room: B125
Period 12:53
PE 6
12:53 PM - 1:50 PM
Teacher: CLARK, J.
Room: Gym
Period 01:53
Science 6
1:53 PM - 2:50 PM
Teacher: PATEL
Room: B131
Day: Fri. A
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Language Arts 6
8:23 AM - 9:20 AM
Teacher: RODRIGUEZ
Room: B121
Period 09:23
FLEX 6
9:23 AM - 10:20 AM
Teacher: ANDERSON
Room: B130
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
Math 6
10:53 AM - 11:20 AM
Teacher: MITCHELL
Room: B128
Period 11:23
Math 6
11:23 AM - 11:50 AM
Teacher: MITCHELL
Room: B128
Period 11:53
Social Studies 6
11:53 AM - 12:20 PM
Teacher: ANDERSON
Room: B130
Period 12:23
Social Studies 6
12:23 PM - 12:50 PM
Teacher: ANDERSON
Room: B130
Period 12:53
French 1A
12:53 PM - 1:50 PM
Teacher: GARCIA
Room: B125
Period 01:53
Family & Consumer Science 6
1:53 PM - 2:50 PM
Teacher: THOMPSON, Sarah
Room: B112
Day: Mon. B
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Math 6
8:23 AM - 9:20 AM
Teacher: MITCHELL
Room: B128
Period 09:23
Social Studies 6
9:23 AM - 10:20 AM
Teacher: ANDERSON
Room: B130
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
French 1A
10:53 AM - 11:20 AM
Teacher: GARCIA
Room: B125
Period 11:23
French 1A
11:23 AM - 11:50 AM
Teacher: GARCIA
Room: B125
Period 11:53
Family & Consumer Science 6
11:53 AM - 12:20 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:23
Family & Consumer Science 6
12:23 PM - 12:50 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:53
Band 6 5x
12:53 PM - 1:50 PM
Teacher: Wilson, David
Room: C156
Period 01:53
Science 6
1:53 PM - 2:50 PM
Teacher: PATEL
Room: B131
Day: Tues. B
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Language Arts 6
8:23 AM - 9:20 AM
Teacher: RODRIGUEZ
Room: B121
Period 09:23
French 1A
9:23 AM - 10:20 AM
Teacher: GARCIA
Room: B125
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
FLEX 6
10:53 AM - 11:20 AM
Teacher: ANDERSON
Room: B130
Period 11:23
FLEX 6
11:23 AM - 11:50 AM
Teacher: ANDERSON
Room: B130
Period 11:53
Family & Consumer Science 6
11:53 AM - 12:20 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:23
Family & Consumer Science 6
12:23 PM - 12:50 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:53
Band 6 5x
12:53 PM - 1:50 PM
Teacher: Wilson, David
Room: C156
Period 01:53
Science 6
1:53 PM - 2:50 PM
Teacher: PATEL
Room: B131
Day: Weds. B
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Language Arts 6
8:23 AM - 9:20 AM
Teacher: RODRIGUEZ
Room: B121
Period 09:23
Math 6
9:23 AM - 10:20 AM
Teacher: MITCHELL
Room: B128
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
Social Studies 6
10:53 AM - 11:20 AM
Teacher: ANDERSON
Room: B130
Period 11:23
Social Studies 6
11:23 AM - 11:50 AM
Teacher: ANDERSON
Room: B130
Period 11:53
Family & Consumer Science 6
11:53 AM - 12:20 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:23
Family & Consumer Science 6
12:23 PM - 12:50 PM
Teacher: THOMPSON, Sarah
Room: B112
Period 12:53
PE 6
12:53 PM - 1:50 PM
Teacher: CLARK, J.
Room: Gym
Period 01:53
Science 6
1:53 PM - 2:50 PM
Teacher: PATEL
Room: B131
Day: Thurs. B
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Language Arts 6
8:23 AM - 9:20 AM
Teacher: RODRIGUEZ
Room: B121
Period 09:23
Math 6
9:23 AM - 10:20 AM
Teacher: MITCHELL
Room: B128
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
Social Studies 6
10:53 AM - 11:20 AM
Teacher: ANDERSON
Room: B130
Period 11:23
Social Studies 6
11:23 AM - 11:50 AM
Teacher: ANDERSON
Room: B130
Period 11:53
French 1A
11:53 AM - 12:20 PM
Teacher: GARCIA
Room: B125
Period 12:23
French 1A
12:23 PM - 12:50 PM
Teacher: GARCIA
Room: B125
Period 12:53
Band 6 5x
12:53 PM - 1:50 PM
Teacher: Wilson, David
Room: C156
Period 01:53
Science 6
1:53 PM - 2:50 PM
Teacher: PATEL
Room: B131
Day: Fri. B
Period HR
Homeroom 6
8:10 AM - 8:20 AM
Teacher: ANDERSON
Room: B130
Period 08:23
Language Arts 6
8:23 AM - 9:20 AM
Teacher: RODRIGUEZ
Room: B121
Period 09:23
FLEX 6
9:23 AM - 10:20 AM
Teacher: ANDERSON
Room: B130
Period 10:23
Lunch 6
10:23 AM - 10:50 AM
Room: CAFE
Period 10:53
Math 6
10:53 AM - 11:20 AM
Teacher: MITCHELL
Room: B128
Period 11:23
Math 6
11:23 AM - 11:50 AM
Teacher: MITCHELL
Room: B128
Period 11:53
Social Studies 6
11:53 AM - 12:20 PM
Teacher: ANDERSON
Room: B130
Period 12:23
Social Studies 6
12:23 PM - 12:50 PM
Teacher: ANDERSON
Room: B130
Period 12:53
French 1A
12:53 PM - 1:50 PM
Teacher: GARCIA
Room: B125
Period 01:53
Family & Consumer Science 6
1:53 PM - 2:50 PM
Teacher: THOMPSON, Sarah
Room: B112`;

            document.getElementById('scheduleInput').value = sampleData;
            showMessage('Sample data loaded! Click "Create Schedule Table" to see the result.', 'success');
        }

        function printSchedule() {
            if (Object.keys(scheduleData).length === 0) {
                showMessage('Please import a schedule first before printing.', 'error');
                return;
            }
            
            window.print();
        }

        // UI State Management
        function showScheduleLoadedState() {
            document.getElementById('importSection').style.display = 'none';
            document.getElementById('scheduleLoadedSection').style.display = 'block';
            document.getElementById('filterInline').style.display = 'flex';
            updateScheduleInfo();
        }

        function showImportSection() {
            document.getElementById('importSection').style.display = 'block';
            document.getElementById('scheduleLoadedSection').style.display = 'none';
            document.getElementById('filterInline').style.display = 'none';
            // Clear the textarea for new input
            document.getElementById('scheduleInput').value = '';
        }

        function updateScheduleInfo() {
            const scheduleInfo = document.getElementById('scheduleInfo');
            
            if (!studentInfo.name && !studentInfo.school && Object.keys(scheduleData).length === 0) {
                scheduleInfo.innerHTML = '';
                return;
            }

            // Count statistics
            const totalDays = Object.keys(scheduleData).length;
            const subjects = new Set();
            const teachers = new Set();
            let totalClasses = 0;

            Object.values(scheduleData).forEach(daySchedule => {
                daySchedule.forEach(period => {
                    if (period.subject && period.subject.trim() && !period.subject.toLowerCase().includes('lunch')) {
                        subjects.add(period.subject.trim());
                        totalClasses++;
                    }
                    if (period.teacher && period.teacher.trim()) {
                        teachers.add(period.teacher.trim());
                    }
                });
            });

            const lastUpdated = new Date().toLocaleDateString();

            // Create condensed info line
            const infoItems = [];
            if (studentInfo.name) infoItems.push(`<strong>Student:</strong> ${studentInfo.name}`);
            if (studentInfo.school) infoItems.push(`<strong>School:</strong> ${studentInfo.school}`);
            infoItems.push(`<strong>Updated:</strong> ${lastUpdated}`);
            const infoLine = infoItems.join(' ‚Ä¢ ');

            scheduleInfo.innerHTML = `
                <h3>üìä Schedule Overview</h3>
                <p style="font-size: 0.8em; margin-bottom: 8px;">${infoLine}</p>
                
                <div class="schedule-stats">
                    <div class="stat-item">
                        <span class="stat-number">${totalDays}</span>
                        <div class="stat-label">Schedule Days</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${subjects.size}</span>
                        <div class="stat-label">Different Subjects</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${teachers.size}</span>
                        <div class="stat-label">Teachers</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${totalClasses}</span>
                        <div class="stat-label">Total Classes</div>
                    </div>
                </div>
            `;
        }

        function clearAll() {
            document.getElementById('scheduleInput').value = '';
            document.getElementById('scheduleDisplay').innerHTML = '';
            document.getElementById('messageArea').innerHTML = '';
            document.getElementById('importSection').style.display = 'block';
            document.getElementById('scheduleLoadedSection').style.display = 'none';
            document.getElementById('filterInline').style.display = 'none';
            document.getElementById('activitySection').style.display = 'none';
            scheduleData = {};
            studentInfo = {};
            activities = [];
            localStorage.removeItem('scheduleViewerState'); // Clear saved state
            localStorage.removeItem('scheduleViewerActivities'); // Clear saved activities
            showMessage('All data cleared!', 'success');
        }

        // Filter functions
        function populateSubjectFilter() {
            const subjectFilter = document.getElementById('subjectFilter');
            const subjects = new Set();
            
            // Collect all unique subjects
            Object.values(scheduleData).forEach(daySchedule => {
                daySchedule.forEach(period => {
                    if (period.subject && period.subject.trim()) {
                        subjects.add(period.subject.trim());
                    }
                });
            });
            
            // Clear existing options except "Show All"
            subjectFilter.innerHTML = '<option value="">Show All Subjects</option>';
            
            // Add subject options
            Array.from(subjects).sort().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectFilter.appendChild(option);
            });
        }

        function applyFilter() {
            const selectedSubject = document.getElementById('subjectFilter').value;
            const allCells = document.querySelectorAll('.class-cell');
            
            allCells.forEach(cell => {
                cell.classList.remove('filtered-highlight', 'filtered-dim');
                
                if (selectedSubject) {
                    const classNameDiv = cell.querySelector('.class-name');
                    if (classNameDiv && classNameDiv.textContent.trim() === selectedSubject) {
                        cell.classList.add('filtered-highlight');
                    } else {
                        cell.classList.add('filtered-dim');
                    }
                }
            });
        }

        function clearFilter() {
            document.getElementById('subjectFilter').value = '';
            applyFilter(); // This will remove all filtering
        }

        // Activity Management Functions
        function showActivitySection() {
            document.getElementById('activitySection').style.display = 'block';
            displayActivities();
        }

        function hideActivitySection() {
            document.getElementById('activitySection').style.display = 'none';
            clearActivityForm();
        }

        function clearActivityForm() {
            document.getElementById('activityName').value = '';
            document.getElementById('activityTime').value = '';
            const checkboxes = ['dayMon', 'dayTue', 'dayWed', 'dayThu', 'dayFri', 'daySat', 'daySun'];
            checkboxes.forEach(id => document.getElementById(id).checked = false);
        }

        function addActivity() {
            const name = document.getElementById('activityName').value.trim();
            const time = document.getElementById('activityTime').value.trim();
            const selectedDays = [];
            
            const dayMapping = {
                'dayMon': 'Mon',
                'dayTue': 'Tues', 
                'dayWed': 'Weds',
                'dayThu': 'Thurs',
                'dayFri': 'Fri',
                'daySat': 'Sat',
                'daySun': 'Sun'
            };
            
            Object.keys(dayMapping).forEach(id => {
                if (document.getElementById(id).checked) {
                    selectedDays.push(dayMapping[id]);
                }
            });

            if (!name || !time || selectedDays.length === 0) {
                showMessage('Please fill in all fields and select at least one day.', 'error');
                return;
            }

            const activity = {
                id: Date.now(),
                name: name,
                time: time,
                days: selectedDays
            };

            activities.push(activity);
            console.log('Activity added:', activity);
            console.log('All activities:', activities);
            saveActivities();
            displayActivities();
            displaySchedule(); // Refresh schedule to show activities
            clearActivityForm();
            showMessage(`Activity "${name}" added successfully! üéâ Check browser console for debug info.`, 'success');
        }

        function editActivity(id) {
            const activity = activities.find(a => a.id === id);
            if (!activity) return;

            document.getElementById('activityName').value = activity.name;
            document.getElementById('activityTime').value = activity.time;
            
            // Clear all checkboxes first
            const dayMapping = {
                'Mon': 'dayMon',
                'Tues': 'dayTue', 
                'Weds': 'dayWed',
                'Thurs': 'dayThu',
                'Fri': 'dayFri',
                'Sat': 'daySat',
                'Sun': 'daySun'
            };
            
            Object.values(dayMapping).forEach(id => {
                document.getElementById(id).checked = false;
            });
            
            // Check the appropriate days
            activity.days.forEach(day => {
                const checkboxId = dayMapping[day];
                if (checkboxId) {
                    document.getElementById(checkboxId).checked = true;
                }
            });

            // Remove the activity and let user re-add it
            deleteActivity(id, false);
            showMessage('Edit the activity details and click "Add Activity" to save changes.', 'success');
        }

        function deleteActivity(id, showConfirm = true) {
            if (showConfirm && !confirm('Are you sure you want to delete this activity?')) {
                return;
            }
            
            activities = activities.filter(a => a.id !== id);
            saveActivities();
            displayActivities();
            displaySchedule(); // Refresh schedule to remove activities
            
            if (showConfirm) {
                showMessage('Activity deleted successfully.', 'success');
            }
        }

        function displayActivities() {
            const container = document.getElementById('activitiesContainer');
            
            if (activities.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No activities added yet.</p>';
                return;
            }

            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-info">
                        <div class="activity-name">${activity.name}</div>
                        <div class="activity-details">${activity.days.join(', ')} ‚Ä¢ ${activity.time}</div>
                    </div>
                    <div class="activity-actions">
                        <button class="edit-activity-btn" onclick="editActivity(${activity.id})">‚úèÔ∏è Edit</button>
                        <button class="delete-activity-btn" onclick="deleteActivity(${activity.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function saveActivities() {
            localStorage.setItem('scheduleViewerActivities', JSON.stringify(activities));
        }

        function loadActivities() {
            try {
                const saved = localStorage.getItem('scheduleViewerActivities');
                if (saved) {
                    activities = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading activities:', error);
                activities = [];
            }
        }

        function checkTimeConflict(scheduleTime, activityTime) {
            // Check if times overlap or if they're the same time slot
            try {
                const parseTimeRange = (timeStr) => {
                    const parts = timeStr.split(' - ');
                    if (parts.length !== 2) return null;
                    
                    const start = parseTime(parts[0]);
                    const end = parseTime(parts[1]);
                    return { start, end };
                };

                const scheduleRange = parseTimeRange(scheduleTime);
                const activityRange = parseTimeRange(activityTime);
                
                if (!scheduleRange || !activityRange) return false;
                
                // Check for overlap
                return (scheduleRange.start < activityRange.end && scheduleRange.end > activityRange.start);
            } catch (error) {
                return false;
            }
        }

        function checkTimeMatch(scheduleTime, activityTime) {
            // Check if this is the exact same time slot or if activity should show
            return scheduleTime === activityTime || checkTimeConflict(scheduleTime, activityTime);
        }

        function displayActivitiesOnlySchedule() {
            const displayArea = document.getElementById('scheduleDisplay');
            
            // Create a simple activities-only schedule
            let html = `
                <div class="student-info">
                    <h2>‚öΩ Your Activities Schedule</h2>
                    <p>Add your school schedule for a complete view</p>
                </div>
            `;

            // Get all unique activity times
            const activityTimes = [...new Set(activities.map(a => a.time))].sort((a, b) => {
                const timeA = a.split(' - ')[0];
                const timeB = b.split(' - ')[0];
                return parseTime(timeA) - parseTime(timeB);
            });

            // Get all unique days from activities
            const allDays = [...new Set(activities.flatMap(a => a.days))];
            const dayOrder = ['Mon', 'Tues', 'Weds', 'Thurs', 'Fri', 'Sat', 'Sun'];
            const sortedDays = dayOrder.filter(day => allDays.includes(day));

            if (activityTimes.length > 0) {
                html += '<div class="schedule-container">';
                html += '<table class="schedule-table">';
                
                // Header row
                html += '<tr><th class="time-column">Time</th>';
                sortedDays.forEach(day => {
                    html += `<th>${day}</th>`;
                });
                html += '</tr>';

                // Activity rows
                activityTimes.forEach(time => {
                    html += '<tr>';
                    html += `<td class="time-column">${time}</td>`;
                    
                    sortedDays.forEach(day => {
                        const dayActivity = activities.find(a => a.time === time && a.days.includes(day));
                        if (dayActivity) {
                            html += `<td class="class-cell activity">
                                <div class="class-name">${dayActivity.name}</div>
                                <div class="teacher-name">Extracurricular Activity</div>
                                <div class="room-name">${dayActivity.time}</div>
                            </td>`;
                        } else {
                            html += '<td class="class-cell">-</td>';
                        }
                    });
                    html += '</tr>';
                });

                html += '</table>';
                html += '</div>';

                // Add legend
                html += `
                    <div class="legend">
                        <h3>üé® Color Legend</h3>
                        <div class="legend-grid">
                            <div class="legend-item activity">‚öΩ Activities</div>
                        </div>
                    </div>
                `;
            }

            displayArea.innerHTML = html;
        }

        // Auto-load saved state on page load
        window.addEventListener('load', function() {
            loadState();
            loadActivities();
            // Display activities if they exist (even without school schedule)
            if (activities.length > 0) {
                displaySchedule();
                displayActivities();
            }
        });
    </script>
</body>
</html>
